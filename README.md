# malloc-example

malloc recreation

## Идея

Выделим некоторую память фиксированного размера(регион), на которой реализуем аллокатор общего пользования. В дальнейшем планируется реализовать сборщик муссора. Цель проекта - разобраться в написании кастомных аллокаторов

При аллокации N байтов выделяется область в памяти размером N байтов и возвращается указатель на её начало. Структура, хранящая этот указатель и размер области(**в кол-ве машинных слов**), называется Chunk(Чанк).Чанк может быть аллоцирован(allocated) или освобожден(freed), в соответствии с этим они хранятся в 2х структурах ChunkList allocated и freed. Структура ChunkList ни что иное, как **всегда отсортированный по указателям на начало чанков** массив чанков + счетчик. 
![Chunks](./pic/Chunks.png)
### Аллокация
Задача аллокатора - проиттерироваться по freed, найти первый попавшийся чанк размером >= запрашиваемое число машинных слов. Затем удалить его из freed, добавить в allocated. Однако это эффективно, его размер чанка всегда совпадает с размеров запрошенным, иначе необходимо возвращать излишек(хвост/tail) обратно во freed
![memalloc](./pic/memalloc.png)
Обратим внимание, что хвост уже находится в freed на своем месте, т.е. нет нужды добавлять наш чанк, достаточно с помощью адресной арифметики "сжать чанк вправо". Также мы стараемся уменьшить фрагментацию во freed, т.е. необходимо объединять соседние чанки, если это возможно, однако здесь это не нужно, т.к. это должно быть сделано ранее и проблема не возникает
### Освобождение
Задача деаллокатора - найти в allocated чанк с переданным указателем, перенести во freed. Однако может быть такая ситуация: при аллокации мы как раз отбрасывали излишек, теперь необходимо присоеденить его обратно(как сказано выше), иначе мы быстро достигнем лимита по кол-ву чанков в силу фрагментации памяти
![memfree](./pic/memfree.png)
Обратим внимание, что хвост уже находится в freed на своем месте, т.е. нет нужды добавлять наш чанк, достаточно с помощью адресной арифметики "расширить хвост влево"

### Детали реализации опущены

## План на будущее
1. Дописать GarbageCollector(сборщик мусора)
2. Переписать ChunkList на куче